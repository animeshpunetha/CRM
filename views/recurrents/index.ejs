<%- include('../partials/header') %>

<div class="container py-4">
  <h1 class="mb-4">Recurring Payments</h1>

  <div class="mb-3 d-flex justify-content-between">
    <div>
      <a href="/recurrents/new" class="btn btn-primary me-2">New Recurring Payment</a>
      <a href="/recurrents/import" class="btn btn-secondary me-2">Import XLSX</a>
      <a href="/recurrents/export" class="btn btn-success">Export XLSX</a>
    </div>
    <div>
      <small>
        Sort by:
        <a href="?sort=account&order=<%= currentSort==='account' && currentOrder==='asc' ? 'desc' : 'asc' %>">
          Account <%= (currentSort==='account' ? (currentOrder==='asc' ? '↑' : '↓') : '') %>
        </a>
        |
        <a href="?sort=firstPaymentDate&order=<%= currentSort==='firstPaymentDate' && currentOrder==='asc' ? 'desc' : 'asc' %>">
          First Payment <%= (currentSort==='firstPaymentDate' ? (currentOrder==='asc' ? '↑' : '↓') : '') %>
        </a>
      </small>
    </div>
  </div>

  <% if (!records || records.length === 0) { %>
    <div class="alert alert-info">No recurring payments defined yet.</div>
  <% } else { %>
    <div class="table-responsive">
      <table class="table table-hover table-striped">
        <thead class="table-light">
          <tr>
            <th>Account</th>
            <th>Contact</th>
            <th>Deal</th>
            <th>Amount (₹)</th>
            <th>Period (months)</th>
            <th>First Payment</th>
            <th>Next Payment</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% records.forEach(rp => {
              // compute next payment date on the fly
              const nextDate = new Date(rp.firstPaymentDate);
              while (nextDate <= new Date()) {
                nextDate.setMonth(nextDate.getMonth() + rp.recurringPeriodMonths);
              }
          %>
            <tr>
              <td><%= rp.account.name %></td>
              <td><%= rp.contact.name %></td>
              <td><%= rp.deal.name %></td>
              <td><%= rp.recurringAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></td>
              <td><%= rp.recurringPeriodMonths %></td>
              <td><%= new Date(rp.firstPaymentDate).toLocaleDateString() %></td>
              <td><%= nextDate.toLocaleDateString() %></td>
              <td class="text-nowrap">
                <a href="/recurrents/<%= rp._id %>/edit" class="btn btn-sm btn-warning me-2">Edit</a>
                <form action="/recurrents/<%= rp._id %>?_method=DELETE" method="POST" class="d-inline">
                  <button type="submit" class="btn btn-sm btn-danger"
                    onclick="return confirm('Are you sure you want to delete this record?')">
                    Delete
                  </button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>
</div>

<%- include('../partials/footer') %>
